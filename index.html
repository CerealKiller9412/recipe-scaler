<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>配方比例缩放器</title>
<style>
  :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --card:#111827; --accent:#38bdf8; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  .wrap{max-width:880px;margin:0 auto;padding:16px}
  h1{font-size:1.4rem;margin:0 0 8px}
  p{color:var(--muted);margin:.25rem 0 .75rem}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:12px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.2)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1 1 120px}
  label{font-size:.85rem;color:var(--muted)}
  input,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--fg);font-size:16px}
  button{background:linear-gradient(180deg,#0ea5e9,#0284c7);border:0;font-weight:600}
  button.ghost{background:#0b1220;border:1px solid #334155}
  button:active{transform:translateY(1px)}
  .small{font-size:.8rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left;font-size:.95rem}
  code{background:#0b1220;padding:2px 6px;border-radius:8px;border:1px solid #334155}
</style>
</head>
<body>
  <div class="wrap">
    <h1>配方比例缩放器</h1>
    <p>输入每个材料的数量</p>

    <div class="card">
      <div class="row">
        <div>
          <label>初始面粉（磅）</label>
          <input id="flourLb" type="number" inputmode="decimal" placeholder="例如：25" />
        </div>
        <div>
          <label>初始面粉（盎司）</label>
          <input id="flourOz" type="number" inputmode="decimal" placeholder="例如：4" />
        </div>
        <div>
          <label>目标面粉量（磅）</label>
          <input id="targetLb" type="number" inputmode="decimal" value="5" />
        </div>
      </div>
      <p class="small">缩放因子计算方式：<code>目标面粉盎司 ÷ 初始面粉盎司</code></p>
    </div>

    <div class="card" id="ingCard">
      <div class="row">
        <div style="flex:2 1 200px">
          <label>材料名称</label>
          <input id="ingName" placeholder="材料名称" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>数量（例如 <code>1gal,3qt,2-3/4cup</code> 或 <code>1lb,8oz</code>）</label>
        <input id="ingAmt" placeholder="在此输入" />
      </div>
      <div class="row">
        <button id="addIng">增加材料</button>
        <button class="ghost" id="loadExample">加载示例（您的配方）</button>
      </div>

      <table id="ingTable" aria-label="ingredients">
        <thead>
          <tr><th>#</th><th>名称</th><th>类型</th><th>初始量</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <button id="compute">计算</button>
        </div>
        <div>
          <button class="ghost" id="clearAll">清除</button>
        </div>
      </div>
      <div id="out"></div>
    </div>

    <p class="small">支持的单位（不区分大小写）：<strong>gal, qt, cup, tbsp, lb, oz, g</strong>。支持分数，例如 <code>1-1/2</code> 或 <code>2 3/4</code>。每个单位用逗号分隔。</p>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const tbody = $('#ingTable tbody');
  const state = { ings: [] };

  const CUP_PER_GAL = 16;
  const CUP_PER_QT  = 4;
  const CUP_PER_TBSP = 1/16;
  const OZ_PER_LB = 16;
  const OZ_PER_G = 1/28.349523125;

  function parseAmount(text){
    let totalVol = 0, totalWt = 0, hasVol = false, hasWt = false;
    const parts = String(text||'').split(/\s*,\s*/);
    for (const raw of parts){
      const part = raw.trim();
      if (!part) continue;
  
      // number (with digits/.,-/fractions) + optional space + unit
      const m = part.match(/^([0-9][0-9\/.\-]*)\s*([a-zA-Z]+)$/);
      if (!m) continue;
  
      const n = parseNum(m[1]);
      const u = normUnit(m[2]);
  
      if (['gal','qt','cup','tbsp'].includes(u)){
        hasVol = true;
        if (u==='gal')  totalVol += n*16;
        if (u==='qt')   totalVol += n*4;
        if (u==='cup')  totalVol += n;
        if (u==='tbsp') totalVol += n*(1/16);
      } else if (['lb','oz','g'].includes(u)){
        hasWt = true;
        if (u==='lb') totalWt += n*16;
        if (u==='oz') totalWt += n;
        if (u==='g')  totalWt += n*(1/28.349523125);
      }
    }
    if (hasVol && hasWt) return {kind:'mixed'};
    if (hasWt) return {kind:'weight', ounces: totalWt};
    if (hasVol) return {kind:'volume', cups: totalVol};
    return null;
  }

  function normUnit(u){
    u = (u||'').toLowerCase().replace(/\./g,'').trim();
    if(['gal','gallon','gallons'].includes(u)) return 'gal';
    if(['qt','quart','quarts'].includes(u)) return 'qt';
    if(['cup','cups','c'].includes(u)) return 'cup';
    if(['tbsp','tablespoon','tablespoons','tbs','t'].includes(u)) return 'tbsp';
    if(['lb','lbs','pound','pounds'].includes(u)) return 'lb';
    if(['oz','ounce','ounces'].includes(u)) return 'oz';
    if(['g','gram','grams'].includes(u)) return 'g';
    return u;
  }

  function parseAmount(text){
    let totalVol = 0; let totalWt = 0; let hasVol = false; let hasWt = false;
    const parts = String(text||'').split(/\s*,\s*/);
    for(const part of parts){
      if(!part.trim()) continue;
      const m = part.trim().match(/^[0-9][0-9\/.\-]*\s*([a-zA-Z]+)$/) || part.trim().match(/^([0-9][0-9\/.\-]*)\s*([a-zA-Z]+)$/);
      if(!m) continue;
      const n = parseNum(m[1] || part.trim().match(/^([0-9][0-9\/.\-]*)/)[1]);
      const u = normUnit((m[2] || part.trim().match(/([a-zA-Z]+)$/)[1]));
      if(['gal','qt','cup','tbsp'].includes(u)){
        hasVol = true;
        if(u==='gal') totalVol += n*CUP_PER_GAL;
        if(u==='qt') totalVol += n*CUP_PER_QT;
        if(u==='cup') totalVol += n;
        if(u==='tbsp') totalVol += n*CUP_PER_TBSP;
      } else if(['lb','oz','g'].includes(u)){
        hasWt = true;
        if(u==='lb') totalWt += n*OZ_PER_LB;
        if(u==='oz') totalWt += n;
        if(u==='g') totalWt += n*OZ_PER_G;
      }
    }
    if(hasVol && hasWt) return {kind:'mixed'};
    if(hasWt) return {kind:'weight', ounces: totalWt};
    if(hasVol) return {kind:'volume', cups: totalVol};
    return null;
  }

  function fmtCupsToCupTbsp(cups){
    const cup = Math.floor(cups + 1e-9);
    const remCup = cups - cup;
    let tbsp = Math.round(remCup * 16);
    let ccup = cup; let ctbs = tbsp;
    if(tbsp === 16){ ccup += 1; ctbs = 0; }
    const parts = [];
    parts.push(`${ccup} 杯`);
    if(ctbs) parts.push(`${ctbs} 汤匙`);
    return parts.join(' ');
  }

  function fmtOzToLbOz(oz){
    const total = Math.round(oz * 100) / 100;
    const lb = Math.floor(total / OZ_PER_LB);
    const roz = Math.round((total - lb*OZ_PER_LB) * 100) / 100;
    const parts = [];
    if(lb) parts.push(`${lb} 磅`);
    parts.push(`${roz % 1 === 0 ? roz.toFixed(0) : roz} 盎司`);
    return parts.join(' ');
  }

  function renderTable(){
    tbody.innerHTML = '';
    state.ings.forEach((ing,i)=>{
      const tr = document.createElement('tr');
      const norm = ing.kind==='volume' ? `${ing.base.toFixed(3)} 杯` : `${ing.base.toFixed(3)} 盎司`;
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(ing.name)}</td><td>${ing.kind}</td><td>${norm}</td><td><button class="ghost" data-del="${i}">删除</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
  }

  $('#addIng').addEventListener('click', ()=>{
    const name = $('#ingName').value.trim() || `材料 ${state.ings.length+2}`;
    const amtText = $('#ingAmt').value.trim();
    if(!amtText){ alert('请输入材料数量'); return; }
    const parsed = parseAmount(amtText);
    if(!parsed){ alert('无法解析单位。请使用逗号分隔，例如 1gal,3qt,2-3/4cup 或 1lb,8oz'); return; }
    if(parsed.kind==='mixed'){ alert('请不要在同一行材料中混合体积和重量单位。'); return; }
    const base = parsed.kind==='volume' ? parsed.cups : parsed.ounces;
    state.ings.push({ name, kind: parsed.kind, original: amtText, base });
    $('#ingAmt').value='';
    $('#ingName').value='';
    renderTable();
  });

  tbody.addEventListener('click', (e)=>{
    const i = e.target && e.target.dataset && e.target.dataset.del;
    if(i!=null){ state.ings.splice(Number(i),1); renderTable(); }
  });

  $('#clearAll').addEventListener('click', ()=>{
    state.ings = []; renderTable(); $('#out').innerHTML='';
    $('#flourLb').value=''; $('#flourOz').value='';
  });

  $('#compute').addEventListener('click', ()=>{
    const fLb = parseNum($('#flourLb').value);
    const fOz = parseNum($('#flourOz').value);
    const tLb = parseNum($('#targetLb').value || '5');
    const originalFlourOz = fLb*OZ_PER_LB + fOz;
    const targetFlourOz   = tLb*OZ_PER_LB;
    if(!originalFlourOz || !targetFlourOz){
      alert('请输入原始面粉重量（磅 + 盎司）和目标面粉重量（磅）。');
      return;
    }
    const factor = targetFlourOz / originalFlourOz;

    let html = `<h3>缩放后的配方</h3>`;
    html += `<table><thead><tr><th>#</th><th>材料</th><th>缩放数量</th></tr></thead><tbody>`;
    html += `<tr><td>1</td><td>面粉（基准）</td><td>${tLb} 磅 (= ${targetFlourOz} 盎司)</td></tr>`;

    state.ings.forEach((ing, idx)=>{
      let scaledDisp = '';
      if(ing.kind==='volume'){
        const scaled = ing.base * factor;
        scaledDisp = fmtCupsToCupTbsp(scaled);
      } else {
        const scaled = ing.base * factor;
        scaledDisp = fmtOzToLbOz(scaled);
      }
      html += `<tr><td>${idx+2}</td><td>${escapeHtml(ing.name)}</td><td>${scaledDisp}</td></tr>`;
    });

    html += `</tbody></table>`;
    $('#out').innerHTML = html;
  });

  $('#loadExample').addEventListener('click', ()=>{
    $('#flourLb').value = '25';
    $('#flourOz').value = '4';
    $('#targetLb').value = '5';

    state.ings = [
      { name:'材料 2', kind:'volume', original:'2gal,1qt,1.5cup', base: (2*CUP_PER_GAL)+(1*CUP_PER_QT)+1.5 },
      { name:'材料 3', kind:'volume', original:'2-3/4cup,1tbsp', base: 2.75 + (1*CUP_PER_TBSP) },
      { name:'材料 4', kind:'volume', original:'1gal,1qt,2.5cup', base: (1*CUP_PER_GAL)+(1*CUP_PER_QT)+2.5 }
    ];
    renderTable();
  });

})();
</script>
</body>
</html>
